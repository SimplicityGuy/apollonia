---
name: CI/CD Pipeline

on:
  workflow_dispatch:

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

env:
  REGISTRY: ghcr.io
  IMAGE_NAME: ${{ github.actor }}/apollonia

jobs:
  # Quality checks (fast feedback)
  quality:
    name: Quality Checks
    uses: ./.github/workflows/quality.yml
    permissions:
      contents: read
      security-events: write
      checks: write

  # Comprehensive testing
  tests:
    name: Test Suite
    uses: ./.github/workflows/test.yml
    needs: quality
    permissions:
      contents: read
      checks: write
      pull-requests: write
      packages: read
    secrets: inherit

  # Docker builds and deployment
  docker:
    name: Docker Build & Deploy
    uses: ./.github/workflows/docker.yml
    needs: tests
    permissions:
      contents: read
      packages: write
      security-events: write
      id-token: write
    secrets: inherit
    with:
      push_images: ${{ github.event_name != 'pull_request' }}

  # Security scanning
  security:
    name: Security Scan
    runs-on: ubuntu-latest
    timeout-minutes: 15
    needs: quality

    permissions:
      contents: read
      security-events: write

    steps:
      - name: 📥 Checkout repository
        uses: actions/checkout@v4

      - name: 🔧 Setup Python environment
        uses: ./.github/actions/setup-python-env
        with:
          python-version: '3.12'
          install-just: false

      - name: 🔒 Run pip-audit security scan
        run: |
          uv run pip-audit --format=json --output=pip-audit-report.json --progress-spinner=off || true

      - name: 🔍 Initialize CodeQL
        uses: github/codeql-action/init@v3
        with:
          languages: python, javascript
          queries: security-and-quality

      - name: 🔍 Perform CodeQL Analysis
        uses: github/codeql-action/analyze@v3
        with:
          category: "/language:python"

      - name: 📤 Upload security reports
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: security-reports
          path: |
            pip-audit-report.json

  # Dependency updates check
  dependency-review:
    name: Dependency Review
    runs-on: ubuntu-latest
    timeout-minutes: 5
    if: github.event_name == 'pull_request'

    steps:
      - name: 📥 Checkout repository
        uses: actions/checkout@v4

      - name: 🔍 Dependency Review
        uses: actions/dependency-review-action@v4
        with:
          fail-on-severity: moderate
          warn-only: false

  # Performance benchmarks
  benchmarks:
    name: Performance Benchmarks
    runs-on: ubuntu-latest
    timeout-minutes: 20
    needs: tests
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'

    steps:
      - name: 📥 Checkout repository
        uses: actions/checkout@v4

      - name: 🔧 Setup Python environment
        uses: ./.github/actions/setup-python-env
        with:
          python-version: '3.12'
          install-just: true

      - name: ⚡ Run performance benchmarks
        timeout-minutes: 15
        run: just test-benchmarks

      - name: 📊 Store benchmark results
        uses: benchmark-action/github-action-benchmark@v1
        if: hashFiles('benchmark-results.json') != ''
        with:
          tool: 'pytest'
          output-file-path: benchmark-results.json
          github-token: ${{ secrets.GITHUB_TOKEN }}
          auto-push: true
          comment-on-alert: true
          summary-always: true

  # Generate overall status
  status:
    name: CI/CD Status
    runs-on: ubuntu-latest
    timeout-minutes: 5
    needs: [quality, tests, docker, security]
    if: always()

    steps:
      - name: 📊 Generate overall status
        run: |
          echo "## 🚀 CI/CD Pipeline Status" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Stage | Status | Duration |" >> $GITHUB_STEP_SUMMARY
          echo "|-------|--------|----------|" >> $GITHUB_STEP_SUMMARY
          echo "| Quality Checks | ${{ needs.quality.result == 'success' && '✅ Passed' || '❌ Failed' }} | - |" >> $GITHUB_STEP_SUMMARY
          echo "| Test Suite | ${{ needs.tests.result == 'success' && '✅ Passed' || '❌ Failed' }} | - |" >> $GITHUB_STEP_SUMMARY
          echo "| Docker Build | ${{ needs.docker.result == 'success' && '✅ Passed' || '❌ Failed' }} | - |" >> $GITHUB_STEP_SUMMARY
          echo "| Security Scan | ${{ needs.security.result == 'success' && '✅ Passed' || '❌ Failed' }} | - |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          # Set overall status
          if [[ "${{ needs.quality.result }}" == "success" && \
                "${{ needs.tests.result }}" == "success" && \
                "${{ needs.docker.result }}" == "success" && \
                "${{ needs.security.result }}" == "success" ]]; then
            echo "🎉 **Overall Status: ✅ SUCCESS**" >> $GITHUB_STEP_SUMMARY
            exit 0
          else
            echo "⚠️ **Overall Status: ❌ FAILURE**" >> $GITHUB_STEP_SUMMARY
            exit 1
          fi
