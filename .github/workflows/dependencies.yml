---
name: Dependencies

on:
  schedule:
    - cron: '0 2 * * 1'  # Weekly on Monday at 2 AM UTC
  workflow_dispatch:
    inputs:
      update_type:
        description: 'Type of updates to perform'
        required: true
        default: 'patch'
        type: choice
        options:
          - patch
          - minor
          - major
          - all

permissions:
  contents: write
  pull-requests: write

jobs:
  # Update Python dependencies
  update-python:
    name: Update Python Dependencies
    runs-on: ubuntu-latest
    timeout-minutes: 15

    steps:
      - name: ðŸ“¥ Checkout repository
        uses: actions/checkout@v6
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: ðŸ”§ Setup Python environment
        uses: ./.github/actions/setup-python-env
        with:
          python-version: '3.12'
          install-dependencies: false

      - name: ðŸ”„ Update dependencies
        run: |
          echo "ðŸ”„ Updating Python dependencies..."

          # Update lock file
          uv lock --upgrade

          # Check for actual changes
          if git diff --quiet uv.lock; then
            echo "No Python dependency updates available"
            echo "HAS_PYTHON_UPDATES=false" >> "$GITHUB_ENV"
          else
            echo "Python dependencies updated"
            echo "HAS_PYTHON_UPDATES=true" >> "$GITHUB_ENV"
          fi

      - name: ðŸ§ª Test updated dependencies
        if: env.HAS_PYTHON_UPDATES == 'true'
        timeout-minutes: 10
        run: |
          echo "ðŸ§ª Testing updated dependencies..."
          uv sync --frozen --all-extras
          just test-python-unit
          just lint-backend
          just typecheck-backend

      - name: ðŸ“¦ Generate dependency report
        if: env.HAS_PYTHON_UPDATES == 'true'
        run: |
          echo "ðŸ“¦ Generating dependency update report..."

          # Get updated packages
          git diff uv.lock > python-deps.diff

          # Create report
          cat > python-update-report.md << EOF
          ## Python Dependencies Update

          ### Updated Packages
          \`\`\`diff
          $(git diff uv.lock | head -50)
          \`\`\`

          ### Testing Status
          - âœ… Unit tests passed
          - âœ… Linting passed
          - âœ… Type checking passed
          EOF

      - name: ðŸ“¤ Upload Python update artifacts
        if: env.HAS_PYTHON_UPDATES == 'true'
        uses: actions/upload-artifact@v4
        with:
          name: python-dependency-updates
          path: |
            python-deps.diff
            python-update-report.md

  # Update Node.js dependencies
  update-nodejs:
    name: Update Node.js Dependencies
    runs-on: ubuntu-latest
    timeout-minutes: 15

    defaults:
      run:
        working-directory: frontend

    steps:
      - name: ðŸ“¥ Checkout repository
        uses: actions/checkout@v6
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: ðŸ”§ Setup frontend environment
        uses: ./.github/actions/setup-frontend-env
        with:
          node-version: '22'
          install-dependencies: false
          install-just: true

      - name: ðŸ”„ Update dependencies
        run: |
          echo "ðŸ”„ Updating Node.js dependencies..."

          UPDATE_TYPE="${{ github.event.inputs.update_type || 'patch' }}"

          case $UPDATE_TYPE in
            patch)
              npm update
              ;;
            minor)
              npx npm-check-updates -u --target minor
              npm install
              ;;
            major)
              npx npm-check-updates -u --target latest
              npm install
              ;;
            all)
              npx npm-check-updates -u
              npm install
              ;;
          esac

          # Check for changes
          if git diff --quiet package.json package-lock.json; then
            echo "No Node.js dependency updates available"
            echo "HAS_NODE_UPDATES=false" >> "$GITHUB_ENV"
          else
            echo "Node.js dependencies updated"
            echo "HAS_NODE_UPDATES=true" >> "$GITHUB_ENV"
          fi

      - name: ðŸ§ª Test updated dependencies
        if: env.HAS_NODE_UPDATES == 'true'
        timeout-minutes: 10
        run: |
          echo "ðŸ§ª Testing updated dependencies..."
          just test-frontend-deps

      - name: ðŸ”’ Security audit
        if: env.HAS_NODE_UPDATES == 'true'
        run: |
          echo "ðŸ”’ Running security audit..."
          npm audit --audit-level=moderate

      - name: ðŸ“¦ Generate dependency report
        if: env.HAS_NODE_UPDATES == 'true'
        run: |
          echo "ðŸ“¦ Generating Node.js dependency update report..."

          # Get updated packages
          git diff package.json package-lock.json > ../nodejs-deps.diff

          # Create report
          cat > ../nodejs-update-report.md << EOF
          ## Node.js Dependencies Update

          ### Updated Packages
          \`\`\`diff
          $(git diff package.json | head -50)
          \`\`\`

          ### Testing Status
          - âœ… Linting passed
          - âœ… Type checking passed
          - âœ… Unit tests passed
          - âœ… Build successful
          - âœ… Security audit passed
          EOF

      - name: ðŸ“¤ Upload Node.js update artifacts
        if: env.HAS_NODE_UPDATES == 'true'
        uses: actions/upload-artifact@v4
        with:
          name: nodejs-dependency-updates
          path: |
            nodejs-deps.diff
            nodejs-update-report.md

  # Create pull request
  create-pr:
    name: Create Dependency Update PR
    runs-on: ubuntu-latest
    timeout-minutes: 10
    needs: [update-python, update-nodejs]
    if: always()

    steps:
      - name: ðŸ“¥ Checkout repository
        uses: actions/checkout@v6
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: ðŸ”§ Setup Python environment
        uses: ./.github/actions/setup-python-env
        with:
          python-version: '3.12'
          install-dependencies: false

      - name: ðŸ”§ Setup frontend environment
        uses: ./.github/actions/setup-frontend-env
        with:
          node-version: '22'
          install-dependencies: false
          install-just: true

      - name: ðŸ”„ Apply all updates
        run: |
          echo "ðŸ”„ Applying dependency updates..."

          # Python updates
          uv lock --upgrade

          # Node.js updates
          cd frontend
          UPDATE_TYPE="${{ github.event.inputs.update_type || 'patch' }}"

          case $UPDATE_TYPE in
            patch)
              npm update
              ;;
            minor)
              npx npm-check-updates -u --target minor
              npm install
              ;;
            major)
              npx npm-check-updates -u --target latest
              npm install
              ;;
            all)
              npx npm-check-updates -u
              npm install
              ;;
          esac

          cd ..

      - name: ðŸ§ª Run full test suite
        timeout-minutes: 15
        run: |
          echo "ðŸ§ª Running full test suite..."

          # Python tests
          uv sync --frozen --all-extras
          just test-python-unit
          just lint-backend
          just typecheck-backend

          # Node.js tests
          just test-frontend-deps

      - name: ðŸ“‹ Check for changes
        id: changes
        run: |
          if git diff --quiet; then
            echo "No dependency updates to commit"
            echo "has_changes=false" >> "$GITHUB_OUTPUT"
          else
            echo "Dependency updates available"
            echo "has_changes=true" >> "$GITHUB_OUTPUT"
          fi

      - name: ðŸ“ Generate PR body
        if: steps.changes.outputs.has_changes == 'true'
        run: |
          cat > pr-body.md << EOF
          ## ðŸ”„ Automated Dependency Updates

          This PR contains automated dependency updates for both Python and Node.js packages.

          ### Update Type
          **${{ github.event.inputs.update_type || 'patch' }}** updates

          ### What's Changed

          #### Python Dependencies
          $(git diff uv.lock | head -20 | sed 's/^/- /')

          #### Node.js Dependencies
          $(git diff frontend/package.json | head -20 | sed 's/^/- /')

          ### Testing
          - âœ… Python unit tests passed
          - âœ… Python linting and type checking passed
          - âœ… Node.js tests passed
          - âœ… Node.js linting and type checking passed
          - âœ… Frontend build successful

          ### Security
          - âœ… No high-severity vulnerabilities detected

          ---

          ðŸ¤– This PR was automatically created by the dependency update workflow.
          EOF

      - name: ðŸ”€ Create Pull Request
        if: steps.changes.outputs.has_changes == 'true'
        uses: peter-evans/create-pull-request@v7
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          commit-message: |
            chore: update dependencies (${{ github.event.inputs.update_type || 'patch' }})

            - Update Python dependencies via uv lock --upgrade
            - Update Node.js dependencies (${{ github.event.inputs.update_type || 'patch' }} level)
            - All tests passing
            - Security audit clean

            ðŸ¤– Generated by dependency update workflow
          title: "ðŸ”„ Automated Dependency Updates (${{ github.event.inputs.update_type || 'patch' }})"
          body-path: pr-body.md
          branch: dependencies/auto-update-${{ github.run_number }}
          delete-branch: true
          labels: |
            dependencies
            automated
            ${{ github.event.inputs.update_type || 'patch' }}
          reviewers: |
            ${{ github.actor }}
          draft: false

  # Security scan for dependencies
  security-scan:
    name: Security Scan
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - name: ðŸ“¥ Checkout repository
        uses: actions/checkout@v6

      - name: ðŸ”§ Setup Python environment
        uses: ./.github/actions/setup-python-env
        with:
          python-version: '3.12'
          install-dependencies: false

      - name: ðŸ“¦ Install dependencies
        run: uv sync --frozen --all-extras

      - name: ðŸ”’ Python security scan
        run: |
          echo "ðŸ”’ Running Python security scan..."
          uv run pip-audit --format=json --output=python-security.json || true

      - name: ðŸ”§ Setup frontend environment
        uses: ./.github/actions/setup-frontend-env
        with:
          node-version: '22'
          install-dependencies: false

      - name: ðŸ”’ Node.js security scan
        run: |
          echo "ðŸ”’ Running Node.js security scan..."
          cd frontend
          npm audit --json > ../nodejs-security.json || true
          cd ..

      - name: ðŸ“¤ Upload security reports
        uses: actions/upload-artifact@v4
        with:
          name: security-reports
          path: |
            python-security.json
            nodejs-security.json
